
#include "ok.h"
#include "rana.h"
#include "coccodrillo.h"
#include "utilities.h"

WINDOW* wgioco;

void controllo(int pipe_fd[]);

//void generaCoccodrilli(int pipe_fd[]);
void cleanupGame(Flusso* fiume, Processo* coccodrilli);


int main()
{
    int pipe_fd[2];
    avviaPipe(pipe_fd);
    avviancurses();

    avviaRana(pipe_fd);
    

    controllo(pipe_fd);

    endwin();
}



void controllo(int pipe_fd[]) 
{
    int* open_pipe=pipe_fd;
    

    wgioco=newwin(NLINES, NCOLS, 0, 0);

    Oggetto ranocchia={'r', NLINES-ALTEZZA_RANA-1, NCOLS/2};
    Oggetto temp, proiettile;

    Flusso* fiume=avviaFlussi();
    Processo coccodrilli[MAX_COCCODRILLI];

    avviaCoccodrilli(fiume, coccodrilli, pipe_fd);
    close(pipe_fd[1]);

    while(true)
    {
        wclear(wgioco);
        box(wgioco, ACS_VLINE, ACS_HLINE);
        stampaRana(ranocchia, wgioco);

        for(int i=0; i<NUMERO_FLUSSI; i++)
        {
            mvwprintw(wgioco, fiume[i].y, 2, "altezza %d", fiume[i].y);
        }

        
        
        if(read(pipe_fd[0], &temp, sizeof(Oggetto)) == -1){
            perror("lettura fallita");
            exit(89);
        }
        switch(temp.id)
        {
            case 'r':
                ranocchia.x+=temp.x;
                ranocchia.y+=temp.y;
                if(ranocchia.x<=0) ranocchia.x=1;
                if(ranocchia.y<=0) ranocchia.y=1;
                if(ranocchia.x>=NCOLS-LARGHEZZA_RANA) ranocchia.x=NCOLS-LARGHEZZA_RANA - 1;
                if(ranocchia.y>=NLINES-ALTEZZA_RANA) ranocchia.y=NLINES-ALTEZZA_RANA -1 ;
                break;
            case 'q':
                cleanupGame(fiume, coccodrilli); 
                
                break;
            case 'c':
                int i=2 + temp.y / 4;
                coccodrilli[i].item=temp;
                stampaCoccodrilli(coccodrilli, wgioco);
                break;
        }
        wrefresh(wgioco);
        usleep(DELAY);
    }
}





void liberaFlussi(Flusso* fiume) 
{
    if (fiume != NULL) {
        free(fiume);
    }
}

void cleanupGame(Flusso* fiume,  Processo* coccodrilli)
{
    endwin();
    liberaFlussi(fiume);
    kill(coccodrilli[0].pid,9);
    kill(coccodrilli[1].pid,9);
}
